<!DOCTYPE html>
<html>
<style>
    body {
        font-family: sans-serif;
        padding: 20px;
        text-align: center;
        color: #333;
    }

    .status {
        font-weight: bold;
        margin: 15px 0;
        padding: 10px;
        border-radius: 6px;
        background: #f5f5f5;
    }

    .connected {
        color: #10B981;
        background: #ECFDF5;
        border: 1px solid #10B981;
    }

    .disconnected {
        color: #EF4444;
        background: #FEF2F2;
        border: 1px solid #EF4444;
    }

    .connecting {
        color: #F59E0B;
        background: #FFFBEB;
        border: 1px solid #F59E0B;
    }

    button {
        background: #18A0FB;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 10px;
    }

    button:disabled {
        opacity: 0.5;
        cursor: default;
    }

    button:hover:not(:disabled) {
        background: #0D8DE3;
    }
</style>

<body>
    <h3>⚛️ React Bridge</h3>

    <div id="status" class="status connecting">Initializing...</div>

    <button id="reconnectBtn" onclick="connect()">Reconnect</button>

    <script>
        const statusEl = document.getElementById('status');
        const btn = document.getElementById('reconnectBtn');
        let socket;

        function updateStatus(state, msg) {
            statusEl.className = 'status ' + state;
            statusEl.textContent = msg;
        }

        function connect() {
            if (socket) {
                socket.close();
            }

            updateStatus('connecting', 'Connecting to Server...');
            btn.disabled = true;

            try {
                socket = new WebSocket('ws://localhost:8080');

                socket.onopen = () => {
                    updateStatus('connected', '✅ Connected');
                    btn.disabled = false;
                };

                socket.onclose = () => {
                    updateStatus('disconnected', '❌ Disconnected');
                    btn.disabled = false;
                };

                socket.onerror = (err) => {
                    console.error("WS Error", err);
                    updateStatus('disconnected', '⚠️ Connection Failed');
                    btn.disabled = false;
                };

                socket.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    // Pass message to Figma Sandbox (code.js)
                    parent.postMessage({ pluginMessage: msg }, '*');
                };

            } catch (e) {
                updateStatus('disconnected', 'Error: ' + e.message);
                btn.disabled = false;
            }
        }

        // Connect on load
        setTimeout(connect, 500);
    </script>
</body>

</html>